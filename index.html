<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCSE Progress Tracker - Cloud Enabled</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* ============= LOGIN SCREEN STYLES ============= */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .login-container h1 {
            color: #667eea;
            margin-bottom: 10px;
            text-align: center;
        }

        .login-container p {
            color: #666;
            margin-bottom: 30px;
            text-align: center;
            font-size: 0.9em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-btn:hover {
            background: #5568d3;
        }

        .login-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .error-message {
            background: #fee;
            color: #c00;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }

        .auth-toggle a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .auth-toggle a:hover {
            text-decoration: underline;
        }

        /* ============= MAIN APP CONTAINER ============= */
        .app-container {
            display: none;
        }

        .app-container.show {
            display: block;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left h1 {
            color: #667eea;
            margin-bottom: 5px;
            font-size: 2em;
        }

        .header-left p {
            color: #666;
        }

        .user-info {
            text-align: right;
        }

        .user-email {
            color: #333;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .user-role {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: #d32f2f;
        }

        .sync-status {
            display: inline-block;
            margin-left: 10px;
            padding: 4px 8px;
            background: #4caf50;
            color: white;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .sync-status.syncing {
            background: #ff9800;
        }

        /* Timer Panel Styles */
        .timer-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            display: none;
        }

        .timer-panel.active {
            display: block;
        }

        .timer-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .timer-circle {
            width: 200px;
            height: 200px;
            margin: 0 auto 20px;
            position: relative;
        }

        .timer-time {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .timer-svg {
            transform: rotate(-90deg);
        }

        .timer-circle-bg {
            fill: none;
            stroke: #e0e0e0;
            stroke-width: 8;
        }

        .timer-circle-progress {
            fill: none;
            stroke: #667eea;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s linear;
        }

        .timer-topic-name {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .timer-session-type {
            display: inline-block;
            padding: 5px 15px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .timer-presets {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 8px 15px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .preset-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .subject-tabs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 15px 20px;
            border: none;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .content-panel {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            font-weight: 600;
        }

        .filter-btn:hover {
            transform: translateY(-1px);
        }

        .filter-btn.active {
            border-color: currentColor;
            background: currentColor;
            color: white;
        }

        .filter-btn.red {
            color: #f44336;
        }

        .filter-btn.amber {
            color: #ff9800;
        }

        .filter-btn.green {
            color: #4caf50;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .topic-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s;
            gap: 15px;
        }

        .topic-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .topic-name {
            flex: 1;
            font-weight: 500;
            color: #333;
        }

        .topic-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-btn {
            padding: 8px 16px;
            border: 2px solid;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .status-btn:hover {
            transform: scale(1.05);
        }

        .status-btn.red {
            border-color: #f44336;
            color: #f44336;
        }

        .status-btn.red.active {
            background: #f44336;
            color: white;
        }

        .status-btn.amber {
            border-color: #ff9800;
            color: #ff9800;
        }

        .status-btn.amber.active {
            background: #ff9800;
            color: white;
        }

        .status-btn.green {
            border-color: #4caf50;
            color: #4caf50;
        }

        .status-btn.green.active {
            background: #4caf50;
            color: white;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .action-btn.secondary {
            background: #ff9800;
        }

        .action-btn.secondary:hover {
            background: #f57c00;
        }

        /* Overview View */
        #overviewView {
            display: block;
        }

        #topicListView {
            display: none;
        }

        #topicListView.active {
            display: block;
        }

        #analyticsView {
            display: none;
        }

        #analyticsView.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1em;
        }

        .progress-chart {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .subject-row {
            margin-bottom: 20px;
        }

        .subject-row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .subject-row-header h4 {
            color: #333;
            font-size: 1.1em;
        }

        .subject-percentage {
            color: #667eea;
            font-weight: 600;
        }

        .status-bars {
            display: flex;
            height: 40px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .status-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            transition: all 0.3s;
        }

        .status-bar:hover {
            opacity: 0.9;
        }

        .status-bar.green {
            background: #4caf50;
        }

        .status-bar.amber {
            background: #ff9800;
        }

        .status-bar.red {
            background: #f44336;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .close-btn {
            font-size: 2em;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            line-height: 1;
        }

        .close-btn:hover {
            color: #333;
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1em;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .save-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
        }

        .save-btn:hover {
            background: #5568d3;
        }

        .import-export-btns {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .recommendations {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .recommendations h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        .recommendations ul {
            list-style-position: inside;
            color: #856404;
        }

        .recommendations li {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .user-info {
                text-align: center;
            }

            .header-left h1 {
                font-size: 1.5em;
            }

            .controls {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }

            .filter-buttons {
                width: 100%;
                justify-content: center;
            }

            .topic-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .topic-controls {
                width: 100%;
                justify-content: flex-start;
            }

            .subject-tabs {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <h1>üéì GCSE Tracker</h1>
        <p id="authModeText">Sign in to track your GCSE progress</p>
        
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        
        <form id="authForm">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" required placeholder="your.email@example.com">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button type="submit" id="authButton" class="login-btn">Sign In</button>
        </form>
        
        <div class="auth-toggle">
            <span id="toggleText">Don't have an account?</span>
            <a id="toggleLink">Sign Up</a>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="app-container">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <h1>üéì GCSE Progress Tracker</h1>
                    <p>Track your revision progress across all subjects</p>
                </div>
                <div class="user-info">
                    <div class="user-email" id="userEmail">Loading...</div>
                    <div class="user-role" id="userRole">Role: Student</div>
                    <button class="logout-btn" onclick="showDebugInfo()" style="background: #2196F3; margin-right: 10px;">üîç Debug</button>
                    <button class="logout-btn" onclick="testCompletionHistory()" style="background: #9c27b0; margin-right: 10px;">üß™ Test Completion</button>
                    <button class="logout-btn" onclick="handleLogout()">Logout</button>
                    <span class="sync-status" id="syncStatus">Synced ‚úì</span>
                </div>
            </div>

            <!-- Timer Panel -->
            <div id="timerPanel" class="timer-panel">
                <div class="modal-header">
                    <h2>‚è±Ô∏è Study Timer</h2>
                    <button class="close-btn" onclick="closeTimer()">&times;</button>
                </div>
                <div class="timer-display">
                    <div class="timer-topic-name" id="timerTopicName">Topic Name</div>
                    <div class="timer-session-type" id="timerType">Study Session</div>
                    <div class="timer-circle">
                        <svg class="timer-svg" width="200" height="200">
                            <circle class="timer-circle-bg" cx="100" cy="100" r="90"></circle>
                            <circle id="timerCircleProgress" class="timer-circle-progress" cx="100" cy="100" r="90"
                                style="stroke-dasharray: 565.48; stroke-dashoffset: 0;"></circle>
                        </svg>
                        <div class="timer-time" id="timerTime">25:00</div>
                    </div>
                </div>
                <div class="timer-controls">
                    <button id="startBtn" class="action-btn" onclick="startTimer()">Start</button>
                    <button id="pauseBtn" class="action-btn" onclick="pauseTimer()" style="display: none;">Pause</button>
                    <button id="stopBtn" class="action-btn secondary" onclick="stopTimer()" style="display: none;">Stop & Save</button>
                </div>
                <div class="timer-presets">
                    <button class="preset-btn" onclick="setTimerPreset(5)">5 min</button>
                    <button class="preset-btn" onclick="setTimerPreset(10)">10 min</button>
                    <button class="preset-btn" onclick="setTimerPreset(25)">25 min</button>
                    <button class="preset-btn" onclick="setTimerPreset(45)">45 min</button>
                </div>
            </div>

            <!-- Subject Tabs -->
            <div class="subject-tabs">
                <button class="tab-btn active" data-view="overview" onclick="switchView('overview')">üìä Overview</button>
                <button class="tab-btn" data-view="biology" onclick="showSubject('biology')">üß¨ Biology</button>
                <button class="tab-btn" data-view="chemistry" onclick="showSubject('chemistry')">‚öóÔ∏è Chemistry</button>
                <button class="tab-btn" data-view="physics" onclick="showSubject('physics')">‚öõÔ∏è Physics</button>
                <button class="tab-btn" data-view="maths" onclick="showSubject('maths')">üßÆ Maths</button>
                <button class="tab-btn" data-view="geography" onclick="showSubject('geography')">üåç Geography</button>
                <button class="tab-btn" data-view="french" onclick="showSubject('french')">üá´üá∑ French</button>
                <button class="tab-btn" data-view="english_lang" onclick="showSubject('english_lang')">üìù Eng Lang</button>
                <button class="tab-btn" data-view="english_lit" onclick="showSubject('english_lit')">üìö Eng Lit</button>
                <button class="tab-btn" data-view="history" onclick="showSubject('history')">üìú History</button>
                <button class="tab-btn" data-view="drama" onclick="showSubject('drama')">üé≠ Drama</button>
                <button class="tab-btn" data-view="analytics" onclick="switchView('analytics')">üìà Analytics</button>
            </div>

            <!-- Content Panel -->
            <div class="content-panel">
                <!-- Overview View -->
                <div id="overviewView">
                    <h2 style="color: #667eea; margin-bottom: 20px;">üìä Progress Overview</h2>
                    <div class="stats-grid" id="statsGrid">
                        <!-- Stats will be dynamically inserted -->
                    </div>
                    <div class="progress-chart">
                        <div class="chart-title">Subject Breakdown</div>
                        <div id="subjectBreakdown">
                            <!-- Subject progress bars will be inserted here -->
                        </div>
                    </div>
                    <div class="import-export-btns">
                        <button class="action-btn" onclick="exportData()">üì• Export JSON</button>
                        <button class="action-btn" onclick="exportCSV()">üìä Export CSV</button>
                        <button class="action-btn" onclick="exportDetailedCSV()">üìã Export Detailed CSV</button>
                        <button class="action-btn secondary" onclick="document.getElementById('importFile').click()">üì§ Import Data</button>
                        <button class="action-btn secondary" onclick="confirmReset()">üóëÔ∏è Reset All Data</button>
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                </div>

                <!-- Topic List View -->
                <div id="topicListView">
                    <div class="controls">
                        <input type="text" class="search-box" id="searchBox" placeholder="üîç Search topics..." oninput="filterTopics()">
                        <div class="filter-buttons">
                            <button class="filter-btn red" data-status="red" onclick="toggleFilter('red')">üî¥ Need Work</button>
                            <button class="filter-btn amber" data-status="amber" onclick="toggleFilter('amber')">üü° Getting There</button>
                            <button class="filter-btn green" data-status="green" onclick="toggleFilter('green')">üü¢ Confident</button>
                        </div>
                    </div>
                    <div id="topicsContainer">
                        <!-- Topics will be dynamically inserted -->
                    </div>
                </div>

                <!-- Analytics View -->
                <div id="analyticsView">
                    <h2 style="color: #667eea; margin-bottom: 20px;">üìà Detailed Analytics</h2>
                    <div id="analyticsContent">
                        <!-- Analytics will be dynamically inserted -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="notesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìù Notes</h2>
                <button class="close-btn" onclick="closeNotesModal()">&times;</button>
            </div>
            <p id="notesTopicName" style="color: #666; margin-bottom: 15px;"></p>
            <textarea id="notesTextarea" placeholder="Add notes, tips, or things to remember..."></textarea>
            <button class="save-btn" onclick="saveNotes()">Save Notes</button>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä Progress Report</h2>
                <button class="close-btn" onclick="closeReportModal()">&times;</button>
            </div>
            <div id="reportContent"></div>
        </div>
    </div>

    <script>
        // ============= SUPABASE CONFIGURATION =============
        const SUPABASE_URL = 'https://hpflilrxmsrpqynmenmk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwZmxpbHJ4bXNycHF5bm1lbm1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MTIzNTQsImV4cCI6MjA4NjM4ODM1NH0.Yt_NyIO2xQLYTq274KzYbon_NsTR4A_rV8L2_-CoKBY';
        
        let supabaseClient = null;
        let currentUser = null;
        let userProfile = null;
        let FAMILY_ID = null;

        function initSupabase() {
            try {
                if (!window.supabase) {
                    console.error('Supabase library not loaded');
                    return false;
                }
                
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase initialized successfully');
                return true;
            } catch (error) {
                console.error('Error initializing Supabase:', error);
                return false;
            }
        }

        // ============= AUTHENTICATION FUNCTIONS =============
        let isSignUpMode = false;

        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            const authButton = document.getElementById('authButton');
            const authModeText = document.getElementById('authModeText');
            const toggleText = document.getElementById('toggleText');
            const toggleLink = document.getElementById('toggleLink');

            if (isSignUpMode) {
                authButton.textContent = 'Sign Up';
                authModeText.textContent = 'Create your account';
                toggleText.textContent = 'Already have an account?';
                toggleLink.textContent = 'Sign In';
            } else {
                authButton.textContent = 'Sign In';
                authModeText.textContent = 'Sign in to track your GCSE progress';
                toggleText.textContent = "Don't have an account?";
                toggleLink.textContent = 'Sign Up';
            }
        }

        document.getElementById('toggleLink').addEventListener('click', toggleAuthMode);

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            const authButton = document.getElementById('authButton');

            errorDiv.classList.remove('show');
            successDiv.classList.remove('show');
            
            // Check if email is in allowed_users table before attempting auth
            const userEmail = email.toLowerCase().trim();
            
            try {
                const { data: allowedUser, error: checkError } = await supabaseClient
                    .from('allowed_users')
                    .select('*')
                    .eq('email', userEmail)
                    .single();
                
                if (checkError || !allowedUser) {
                    errorDiv.textContent = '‚õî Access Denied: Only authorized family members can use this tracker.';
                    errorDiv.classList.add('show');
                    return;
                }
                
                console.log('‚úÖ Email authorized:', userEmail);
            } catch (err) {
                errorDiv.textContent = '‚ùå Error checking authorization. Please try again.';
                errorDiv.classList.add('show');
                return;
            }
            
            authButton.disabled = true;
            authButton.textContent = isSignUpMode ? 'Signing up...' : 'Signing in...';

            try {
                if (isSignUpMode) {
                    const { data, error } = await supabaseClient.auth.signUp({
                        email: email,
                        password: password,
                    });

                    if (error) throw error;

                    if (data.user) {
                        successDiv.textContent = 'Account created! You can now sign in.';
                        successDiv.classList.add('show');
                        
                        setTimeout(() => {
                            toggleAuthMode();
                            document.getElementById('password').value = '';
                        }, 2000);
                    }
                } else {
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email: email,
                        password: password,
                    });

                    if (error) throw error;

                    if (data.user) {
                        currentUser = data.user;
                        await loadUserProfile();
                        showApp();
                    }
                }
            } catch (error) {
                console.error('Auth error:', error);
                errorDiv.textContent = error.message || 'Authentication failed';
                errorDiv.classList.add('show');
            } finally {
                authButton.disabled = false;
                authButton.textContent = isSignUpMode ? 'Sign Up' : 'Sign In';
            }
        });

        async function checkAuth() {
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    console.error('Session error:', error);
                    showLogin();
                    return;
                }

                if (session && session.user) {
                    // Check if user is in allowed_users table
                    const userEmail = session.user.email.toLowerCase();
                    
                    const { data: allowedUser, error: checkError } = await supabaseClient
                        .from('allowed_users')
                        .select('*')
                        .eq('email', userEmail)
                        .single();
                    
                    if (checkError || !allowedUser) {
                        console.warn('Unauthorized email attempted access:', userEmail);
                        alert('‚õî Access Denied\n\nYour email is not authorized to use this application.\n\nOnly authorized family members can access this tracker.');
                        await supabaseClient.auth.signOut();
                        showLogin();
                        return;
                    }
                    
                    console.log('‚úÖ User authorized:', userEmail);
                    currentUser = session.user;
                    
                    // Store allowed user info for later use
                    window.allowedUserInfo = allowedUser;
                    
                    await loadUserProfile();
                    showApp();
                } else {
                    showLogin();
                }
            } catch (error) {
                console.error('Error checking auth:', error);
                showLogin();
            }
        }

        async function loadUserProfile() {
            try {
                console.log('Loading user profile for:', currentUser.id, currentUser.email);
                
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error) {
                    console.error('Error loading profile:', error);
                    
                    // If profile doesn't exist (PGRST116 is "no rows returned")
                    if (error.code === 'PGRST116') {
                        console.log('No profile found, checking allowed_users...');
                        
                        // Try to create profile from allowed_users table
                        const { data: allowedUser, error: auError } = await supabaseClient
                            .from('allowed_users')
                            .select('*')
                            .eq('email', currentUser.email)
                            .single();
                        
                        if (!auError && allowedUser) {
                            console.log('Creating profile from allowed_users data:', allowedUser);
                            
                            const { data: newProfile, error: insertError } = await supabaseClient
                                .from('user_profiles')
                                .insert({
                                    user_id: currentUser.id,
                                    email: allowedUser.email,
                                    family_id: allowedUser.family_id || 'family_001',
                                    role: allowedUser.role || 'student'
                                })
                                .select()
                                .single();
                            
                            if (!insertError && newProfile) {
                                console.log('‚úÖ Profile created automatically:', newProfile);
                                userProfile = newProfile;
                                FAMILY_ID = newProfile.family_id;
                                
                                document.getElementById('userEmail').textContent = newProfile.email;
                                document.getElementById('userRole').textContent = `Role: ${newProfile.role.charAt(0).toUpperCase() + newProfile.role.slice(1)}`;
                                
                                await loadProgressData();
                                return;
                            }
                        }
                        
                        // If automatic creation failed, fall back to manual creation
                        await createUserProfile();
                        return;
                    }
                    
                    // For other errors (like RLS policy issues)
                    alert(`‚ö†Ô∏è Cannot load your profile from database.\n\nError: ${error.message}\n\nPossible causes:\n1. Missing Row Level Security policies\n2. user_profiles table doesn't exist\n3. Database connection issue\n\nPlease contact your administrator or check the setup guide.`);
                    return;
                }

                if (!data) {
                    console.error('No profile data returned');
                    await createUserProfile();
                    return;
                }

                userProfile = data;
                FAMILY_ID = data.family_id;
                
                console.log('‚úÖ Profile loaded successfully:', { email: data.email, role: data.role, family_id: FAMILY_ID });
                
                document.getElementById('userEmail').textContent = data.email;
                document.getElementById('userRole').textContent = `Role: ${data.role.charAt(0).toUpperCase() + data.role.slice(1)}`;
                
                await loadProgressData();
            } catch (error) {
                console.error('Error in loadUserProfile:', error);
                alert(`‚ö†Ô∏è Unexpected error loading profile: ${error.message}`);
            }
        }

        async function createUserProfile() {
            try {
                // Prompt user for family setup
                const setupChoice = confirm(
                    'üëã Welcome! No profile found.\n\n' +
                    'Would you like to:\n' +
                    '‚Ä¢ Click OK to CREATE a new family\n' +
                    '‚Ä¢ Click Cancel to JOIN an existing family'
                );

                let familyId;
                let role;

                if (setupChoice) {
                    // Create new family
                    const familyName = prompt('Enter a name for your family (e.g., "Smith Family"):');
                    if (!familyName) {
                        alert('Setup cancelled. Please refresh to try again.');
                        return;
                    }
                    
                    // Generate a simple family ID from the name
                    familyId = familyName.toLowerCase().replace(/[^a-z0-9]/g, '-') + '-' + Date.now();
                    role = 'parent';
                    
                    alert(`‚úÖ Family created!\n\nYour Family ID: ${familyId}\n\nShare this ID with family members so they can join.`);
                } else {
                    // Join existing family
                    familyId = prompt('Enter the Family ID you want to join:');
                    if (!familyId) {
                        alert('Setup cancelled. Please refresh to try again.');
                        return;
                    }
                    
                    role = 'student';
                }

                // Create the profile
                console.log('Creating user profile:', { user_id: currentUser.id, email: currentUser.email, family_id: familyId, role });
                
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .insert({
                        user_id: currentUser.id,
                        email: currentUser.email,
                        family_id: familyId,
                        role: role
                    })
                    .select()
                    .single();

                if (error) {
                    console.error('Error creating profile:', error);
                    alert(`‚ùå Failed to create profile: ${error.message}\n\nPlease check:\n1. The user_profiles table exists\n2. RLS policies allow INSERT\n3. You have the correct permissions`);
                    return;
                }

                console.log('‚úÖ Profile created successfully:', data);
                
                // Reload the profile
                await loadUserProfile();
                
                alert('‚úÖ Profile created successfully! You can now start tracking your progress.');
                
            } catch (error) {
                console.error('Error in createUserProfile:', error);
                alert(`‚ùå Failed to create profile: ${error.message}`);
            }
        }

        async function handleLogout() {
            try {
                // Close session tracking
                if (window.currentSessionId) {
                    await supabaseClient
                        .from('user_sessions')
                        .update({ 
                            logout_time: new Date().toISOString(),
                            last_activity: new Date().toISOString()
                        })
                        .eq('id', window.currentSessionId);
                    
                    if (window.sessionInterval) {
                        clearInterval(window.sessionInterval);
                    }
                }
                
                await supabaseClient.auth.signOut();
                currentUser = null;
                userProfile = null;
                FAMILY_ID = null;
                progressData = {};
                window.currentSessionId = null;
                showLogin();
            } catch (error) {
                console.error('Error logging out:', error);
                alert('Error logging out');
            }
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('appContainer').classList.remove('show');
        }

        async function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').classList.add('show');
            
            // Track login session
            if (currentUser && FAMILY_ID) {
                try {
                    const { data, error } = await supabaseClient
                        .from('user_sessions')
                        .insert({
                            user_id: currentUser.id,
                            family_id: FAMILY_ID,
                            email: currentUser.email,
                            login_time: new Date().toISOString(),
                            last_activity: new Date().toISOString()
                        })
                        .select()
                        .single();
                    
                    if (!error && data) {
                        window.currentSessionId = data.id;
                        console.log('‚úÖ Session tracked:', data.id);
                        
                        // Update session activity every 5 minutes
                        window.sessionInterval = setInterval(async () => {
                            if (window.currentSessionId) {
                                await supabaseClient
                                    .from('user_sessions')
                                    .update({ last_activity: new Date().toISOString() })
                                    .eq('id', window.currentSessionId);
                            }
                        }, 5 * 60 * 1000);
                        
                        // Handle browser/tab close - log logout time
                        window.addEventListener('beforeunload', async (e) => {
                            if (window.currentSessionId) {
                                // Use navigator.sendBeacon for more reliable tracking on page unload
                                const logoutData = {
                                    logout_time: new Date().toISOString(),
                                    last_activity: new Date().toISOString()
                                };
                                
                                // Try to update session before page closes
                                await supabaseClient
                                    .from('user_sessions')
                                    .update(logoutData)
                                    .eq('id', window.currentSessionId);
                            }
                        });
                    }
                } catch (err) {
                    console.error('Failed to track session:', err);
                }
            }
            
            init();
        }

        // ============= DATA SYNC FUNCTIONS =============
        async function loadProgressData() {
            if (!FAMILY_ID) {
                console.warn('Cannot load progress: FAMILY_ID not set');
                return;
            }

            try {
                setSyncStatus(true);
                console.log('üì• Loading progress data for family:', FAMILY_ID);
                
                const { data, error } = await supabaseClient
                    .from('progress')
                    .select('*')
                    .eq('family_id', FAMILY_ID);

                if (error) {
                    console.error('Error loading from database:', error);
                    throw error;
                }

                console.log(`üì• Loaded ${data.length} progress records from cloud`);

                progressData = {};
                let recordCount = 0;
                data.forEach(record => {
                    if (!progressData[record.subject]) {
                        progressData[record.subject] = {};
                    }
                    const key = `${record.section}|${record.topic}`;
                    progressData[record.subject][key] = {
                        status: record.status,
                        notes: record.notes || '',
                        sessions: [],
                        totalMinutes: 0,
                        completed_at: record.completed_at || null,
                        completed_by: record.completed_by || null
                    };
                    recordCount++;
                });

                await loadStudySessions();
                
                console.log(`‚úÖ Successfully loaded ${recordCount} topics with progress`);
                console.log('Progress data structure:', progressData);
                
                // Re-render the current view after loading data
                if (currentSubject) {
                    renderTopics();
                } else {
                    renderOverview();
                }
                
                setSyncStatus(false);
            } catch (error) {
                console.error('‚ùå Error loading progress:', error);
                alert(`Failed to load your progress data: ${error.message}\n\nYour data is safe in the cloud. Please check your connection and refresh.`);
                setSyncStatus(false);
            }
        }

        async function loadStudySessions() {
            if (!FAMILY_ID) return;

            try {
                const { data, error } = await supabaseClient
                    .from('study_sessions')
                    .select('*')
                    .eq('family_id', FAMILY_ID)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                data.forEach(session => {
                    const key = `${session.section}|${session.topic}`;
                    if (!progressData[session.subject]) {
                        progressData[session.subject] = {};
                    }
                    if (!progressData[session.subject][key]) {
                        progressData[session.subject][key] = {
                            status: 'none',
                            notes: '',
                            sessions: [],
                            totalMinutes: 0
                        };
                    }

                    const minutes = Math.round(session.duration_seconds / 60);
                    progressData[session.subject][key].sessions.push({
                        minutes: minutes,
                        type: session.session_type || 'Study',
                        date: session.created_at
                    });
                    progressData[session.subject][key].totalMinutes += minutes;
                });
            } catch (error) {
                console.error('Error loading study sessions:', error);
            }
        }

        async function saveTopicProgress(subject, section, topic, status, notes = '', previousStatus = null) {
            if (!FAMILY_ID) {
                console.error('Cannot save: FAMILY_ID is not set');
                alert('‚ùå Error: Not properly logged in. Please refresh and log in again.');
                return;
            }

            if (!currentUser || !currentUser.email) {
                console.error('Cannot save: currentUser not set');
                alert('‚ùå Error: User session lost. Please refresh and log in again.');
                return;
            }

            try {
                setSyncStatus(true);
                console.log('Saving progress:', { subject, section, topic, status, notes, family_id: FAMILY_ID });
                
                // Use the passed previousStatus, or fall back to reading from progressData
                if (previousStatus === null) {
                    const key = getTopicKey(section, topic);
                    previousStatus = progressData[subject]?.[key]?.status || 'none';
                }
                console.log('Status change: "' + previousStatus + '" -> "' + status + '"');
                
                // Prepare the data to save
                const progressUpdate = {
                    family_id: FAMILY_ID,
                    subject: subject,
                    section: section,
                    topic: topic,
                    status: status,
                    notes: notes,
                    updated_by: currentUser.email
                };
                
                // If marking as green for the first time, add completion date
                if (status === 'green' && previousStatus !== 'green') {
                    progressUpdate.completed_at = new Date().toISOString();
                    progressUpdate.completed_by = currentUser.email;
                }
                
                const { data, error } = await supabaseClient
                    .from('progress')
                    .upsert(progressUpdate, {
                        onConflict: 'family_id,subject,section,topic'
                    })
                    .select();

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                // Track completion history ONLY when status changes TO green from another status
                // (not when already green)
                const isNewCompletion = status === 'green' && previousStatus !== 'green';
                
                if (isNewCompletion) {
                    console.log('üéØ Topic marked as green! Tracking completion...', { subject, section, topic, previousStatus });
                    
                    // First, delete any existing completion records for this topic (to prevent duplicates)
                    await supabaseClient
                        .from('completion_history')
                        .delete()
                        .eq('family_id', FAMILY_ID)
                        .eq('subject', subject)
                        .eq('section', section)
                        .eq('topic', topic)
                        .eq('email', currentUser.email);
                    
                    // Now insert the new completion record
                    const { error: historyError } = await supabaseClient
                        .from('completion_history')
                        .insert({
                            user_id: currentUser.id,
                            family_id: FAMILY_ID,
                            email: currentUser.email,
                            subject: subject,
                            section: section,
                            topic: topic,
                            status: status,
                            previous_status: previousStatus,
                            completed_at: new Date().toISOString()
                        });
                    
                    if (historyError) {
                        console.error('‚ùå Error saving completion history:', historyError);
                    } else {
                        console.log('‚úÖ Completion tracked with date/time!');
                        console.log('üìù Saved to completion_history:', { subject, section, topic, status: 'green' });
                    }
                }
                
                // If status is anything other than green, always remove from completion_history
                // (handles toggle-off, switching to red/amber, and any edge cases)
                if (status !== 'green') {
                    console.log('üóëÔ∏è Status not green - removing from completion history:', { subject, section, topic, status });
                    
                    const { data: deletedData, error: deleteError } = await supabaseClient
                        .from('completion_history')
                        .delete()
                        .eq('family_id', FAMILY_ID)
                        .eq('subject', subject)
                        .eq('section', section)
                        .eq('topic', topic)
                        .eq('email', currentUser.email)
                        .eq('user_id', currentUser.id)
                        .select();
                    
                    if (deleteError) {
                        console.error('‚ùå Delete error:', deleteError.message, deleteError.details, deleteError.hint);
                    } else if (deletedData && deletedData.length > 0) {
                        console.log('‚úÖ Removed', deletedData.length, 'record(s) from completion history');
                    } else {
                        console.warn('‚ö†Ô∏è Delete ran but removed 0 records - possible RLS policy blocking delete');
                    }
                    
                    // Clear completed_at from progress table
                    await supabaseClient
                        .from('progress')
                        .update({ completed_at: null, completed_by: null })
                        .eq('family_id', FAMILY_ID)
                        .eq('subject', subject)
                        .eq('section', section)
                        .eq('topic', topic);
                }
                console.log('‚úÖ Progress saved successfully to cloud:', data);
                setSyncStatus(false);
                
                // Show a brief success indicator
                const syncStatus = document.getElementById('syncStatus');
                if (syncStatus) {
                    const originalText = syncStatus.textContent;
                    syncStatus.textContent = '‚úì Saved!';
                    setTimeout(() => {
                        syncStatus.textContent = originalText;
                    }, 1500);
                }
            } catch (error) {
                console.error('Error saving progress:', error);
                alert(`‚ùå Failed to save progress to cloud: ${error.message}\n\nPlease check your connection and try again.`);
                setSyncStatus(false);
            }
        }

        async function saveTimerSession(subject, section, topic, sessionType, durationSeconds) {
            if (!FAMILY_ID) {
                console.error('Cannot save session: FAMILY_ID not set');
                alert('‚ùå Error: Not properly logged in. Session not saved.');
                return;
            }

            try {
                setSyncStatus(true);
                console.log('Saving timer session:', { subject, section, topic, sessionType, durationSeconds });
                
                const minutes = Math.round(durationSeconds / 60);
                
                // Save to study_sessions table (for backward compatibility)
                const { error: sessionError } = await supabaseClient
                    .from('study_sessions')
                    .insert({
                        family_id: FAMILY_ID,
                        user_id: currentUser.id,
                        subject: subject,
                        section: section,
                        topic: topic,
                        duration_seconds: durationSeconds,
                        session_type: sessionType
                    });

                if (sessionError) {
                    console.error('Error saving to study_sessions:', sessionError);
                    throw sessionError;
                }

                // ALSO save to topic_time_tracking table (for analytics)
                const { error: trackingError } = await supabaseClient
                    .from('topic_time_tracking')
                    .insert({
                        user_id: currentUser.id,
                        family_id: FAMILY_ID,
                        email: currentUser.email,
                        subject: subject,
                        section: section,
                        topic: topic,
                        minutes_spent: minutes,
                        session_type: sessionType,
                        tracked_at: new Date().toISOString()
                    });

                if (trackingError) {
                    console.error('Error saving to topic_time_tracking:', trackingError);
                    // Don't throw - study_sessions was saved successfully
                }

                // Update local progress data
                const key = getTopicKey(section, topic);
                
                if (!progressData[subject]) progressData[subject] = {};
                if (!progressData[subject][key]) {
                    progressData[subject][key] = { status: 'none', notes: '', sessions: [], totalMinutes: 0 };
                }
                
                progressData[subject][key].sessions.push({
                    minutes: minutes,
                    type: sessionType,
                    date: new Date().toISOString()
                });
                progressData[subject][key].totalMinutes += minutes;

                console.log('‚úÖ Study session saved successfully to both tables');
                setSyncStatus(false);
                renderTopics();
            } catch (error) {
                console.error('Error saving study session:', error);
                alert(`‚ùå Failed to save study session: ${error.message}`);
                setSyncStatus(false);
            }
        }

        function setSyncStatus(syncing) {
            const statusEl = document.getElementById('syncStatus');
            if (syncing) {
                statusEl.textContent = 'Syncing...';
                statusEl.classList.add('syncing');
            } else {
                statusEl.textContent = 'Synced ‚úì';
                statusEl.classList.remove('syncing');
            }
        }

        // ============= CURRICULUM DATA =============
        const curriculum = {
            biology: {
                name: 'Biology',
                topics: [
                    {
                        section: '1. Cell Biology',
                        items: ['Eukaryotic and prokaryotic cells', 'Animal and plant cells', 'Cell specialisation', 'Cell differentiation', 'Microscopy', 'Culturing microorganisms', 'Chromosomes', 'Mitosis and the cell cycle', 'Stem cells', 'Diffusion', 'Osmosis', 'Active transport', 'Exchange surfaces']
                    },
                    {
                        section: '2. Organisation',
                        items: ['Principles of organisation', 'The human digestive system', 'The heart and blood vessels', 'Blood', 'Coronary heart disease', 'Health issues', 'The effect of lifestyle on disease', 'Cancer', 'Plant tissues', 'Plant organ system']
                    },
                    {
                        section: '3. Infection and Response',
                        items: ['Communicable (infectious) diseases', 'Viral diseases', 'Bacterial diseases', 'Fungal diseases', 'Protist diseases', 'Human defence systems', 'Vaccination', 'Antibiotics and painkillers', 'Discovering drugs', 'Developing drugs']
                    },
                    {
                        section: '4. Bioenergetics',
                        items: ['Photosynthesis reaction', 'Rate of photosynthesis', 'Uses of glucose from photosynthesis', 'Aerobic and anaerobic respiration', 'Response to exercise', 'Metabolism']
                    },
                    {
                        section: '5. Homeostasis and Response',
                        items: ['Homeostasis', 'Structure and function of nervous system', 'Reflex actions', 'The brain', 'The eye', 'Control of body temperature', 'Human endocrine system', 'Control of blood glucose concentration', 'Maintaining water and nitrogen balance', 'Hormones in human reproduction', 'Contraception', 'Using hormones to treat infertility', 'Negative feedback', 'Plant hormones']
                    },
                    {
                        section: '6. Inheritance, Variation and Evolution',
                        items: ['Sexual and asexual reproduction', 'Meiosis', 'DNA and the genome', 'DNA structure', 'Genetic inheritance', 'Inherited disorders', 'Sex determination', 'Variation and evolution', 'Evolution', 'Selective breeding', 'Genetic engineering', 'Cloning', 'Theory of evolution', 'Speciation', 'Evidence for evolution', 'Fossils', 'Extinction', 'Resistant bacteria', 'Classification']
                    },
                    {
                        section: '7. Ecology',
                        items: ['Communities', 'Abiotic factors', 'Biotic factors', 'Adaptations', 'Levels of organisation', 'How materials are cycled', 'Decomposition', 'Impact of environmental change', 'Biodiversity', 'Waste management', 'Land use', 'Deforestation', 'Global warming', 'Maintaining biodiversity', 'Required Practical: Investigate effect of light on distribution', 'Required Practical: Measure population size using quadrats']
                    }
                ]
            },
            chemistry: {
                name: 'Chemistry',
                topics: [
                    {
                        section: '1. Atomic Structure and the Periodic Table',
                        items: ['Atoms, elements and compounds', 'Mixtures', 'Development of the atomic model', 'Relative electrical charges of subatomic particles', 'Size and mass of atoms', 'Relative atomic mass', 'Electronic structure', 'Development of the periodic table', 'The modern periodic table', 'Group 0', 'Group 1', 'Group 7', 'Properties of transition metals']
                    },
                    {
                        section: '2. Bonding, Structure and Properties of Matter',
                        items: ['Chemical bonds: ionic, covalent and metallic', 'Ionic bonding', 'Ionic compounds', 'Covalent bonding', 'Metallic bonding', 'The three states of matter', 'State symbols', 'Properties of ionic compounds', 'Properties of small molecules', 'Polymers', 'Giant covalent structures', 'Properties of metals and alloys', 'Metals as conductors', 'Diamond', 'Graphite', 'Graphene and fullerenes', 'Size of particles and their properties', 'Uses of nanoparticles']
                    },
                    {
                        section: '3. Quantitative Chemistry',
                        items: ['Conservation of mass', 'Relative formula mass', 'Mass changes when a reactant or product is a gas', 'Chemical measurements, uncertainty and errors', 'Moles (Higher Tier)', 'Amounts of substances in equations (Higher Tier)', 'Using moles to balance equations (Higher Tier)', 'Limiting reactants (Higher Tier)', 'Concentration of solutions']
                    },
                    {
                        section: '4. Chemical Changes',
                        items: ['Metal oxides', 'The reactivity series', 'Extraction of metals and reduction', 'Oxidation and reduction in terms of electrons', 'Acids and pH scale', 'Reactions of acids', 'Neutralisation of acids and salt production', 'The pH scale and neutralisation', 'Titrations (Higher Tier)', 'Strong and weak acids (Higher Tier)', 'The process of electrolysis', 'Electrolysis of molten ionic compounds', 'Using electrolysis to extract metals', 'Electrolysis of aqueous solutions', 'Representation of reactions at electrodes']
                    },
                    {
                        section: '5. Energy Changes',
                        items: ['Energy transfer during exothermic and endothermic reactions', 'Reaction profiles', 'The energy change of reactions', 'Cells and batteries', 'Fuel cells']
                    },
                    {
                        section: '6. The Rate and Extent of Chemical Change',
                        items: ['Calculating rates of reactions', 'Factors affecting rates of reaction', 'Collision theory and activation energy', 'Catalysts', 'Reversible reactions', 'Energy changes and reversible reactions', 'Equilibrium', 'Changing concentration, temperature and pressure (Higher Tier)']
                    },
                    {
                        section: '7. Organic Chemistry',
                        items: ['Crude oil as a mixture of hydrocarbons', 'Fractional distillation', 'Hydrocarbons as fuels', 'Cracking and alkenes', 'Structure and formulae of alkenes', 'Reactions of alkenes', 'Alcohols', 'Carboxylic acids', 'Addition polymerisation', 'Condensation polymerisation (Higher Tier)', 'Amino acids (Higher Tier)', 'DNA (Higher Tier)']
                    },
                    {
                        section: '8. Chemical Analysis',
                        items: ['Purity, formulations and chromatography', 'Chromatography', 'Identification of common gases']
                    },
                    {
                        section: '9. Chemistry of the Atmosphere',
                        items: ['The composition and evolution of the Earth\'s atmosphere', 'Carbon dioxide and methane as greenhouse gases', 'Global climate change', 'The carbon footprint', 'Atmospheric pollutants from fuels']
                    },
                    {
                        section: '10. Using Resources',
                        items: ['Using the Earth\'s resources and sustainable development', 'Potable water', 'Waste water treatment', 'Alternative methods of extracting metals (Higher Tier)', 'Life cycle assessment', 'Ways of reducing the use of resources', 'Corrosion and its prevention', 'Alloys as useful materials', 'Ceramics, polymers and composites', 'The Haber process', 'Production and uses of NPK fertilisers']
                    }
                ]
            },
            physics: {
                name: 'Physics',
                topics: [
                    {
                        section: '1. Energy',
                        items: ['Energy stores and systems', 'Changes in energy', 'Energy changes in systems', 'Power', 'Energy transfers in a system', 'Efficiency', 'Reducing unwanted energy transfers', 'National and global energy resources']
                    },
                    {
                        section: '2. Electricity',
                        items: ['Standard circuit diagram symbols', 'Electrical charge and current', 'Current, resistance and potential difference', 'Resistors', 'Series and parallel circuits', 'Direct and alternating potential difference', 'Mains electricity', 'Plug wiring and fuses', 'Electrical currents and energy transfer', 'Power', 'Energy transfers in everyday appliances', 'The National Grid', 'Static charge', 'Electric fields']
                    },
                    {
                        section: '3. Particle Model of Matter',
                        items: ['Density of materials', 'Changes of state', 'Internal energy', 'Temperature changes in a system', 'Changes of heat and specific latent heat', 'Particle model and pressure']
                    },
                    {
                        section: '4. Atomic Structure',
                        items: ['Atoms and isotopes', 'The development of the atomic model', 'Radioactive decay and nuclear radiation', 'Nuclear equations', 'Half-lives and the random nature of radioactive decay', 'Radioactive contamination', 'Hazards and uses of radioactive emissions and background radiation', 'Nuclear fission', 'Nuclear fusion']
                    },
                    {
                        section: '5. Forces',
                        items: ['Scalar and vector quantities', 'Contact and non-contact forces', 'Gravity', 'Resultant forces', 'Work done and energy transfer', 'Forces and elasticity', 'Moments', 'Levers and gears', 'Pressure in a fluid', 'Pressure differences in fluids', 'Upthrust and atmospheric pressure', 'Describing motion along a line', 'Distance and displacement', 'Speed and velocity', 'Distance-time and velocity-time graphs', 'Acceleration', 'Newton\'s First Law', 'Newton\'s Second Law', 'Newton\'s Third Law', 'Stopping distance', 'Reaction times', 'Momentum (Higher Tier)']
                    },
                    {
                        section: '6. Waves',
                        items: ['Transverse and longitudinal waves', 'Properties of waves', 'Reflection of waves', 'Sound waves', 'Waves for detection and exploration', 'Types of electromagnetic waves', 'Properties of electromagnetic waves', 'Uses and applications of electromagnetic waves', 'Harmful effects of electromagnetic radiation', 'Emission and absorption of infrared radiation', 'Perfect black bodies and radiation']
                    },
                    {
                        section: '7. Magnetism and Electromagnetism',
                        items: ['Poles of a magnet', 'Magnetic fields', 'The magnetic effect of a current', 'Fleming\'s left-hand rule', 'Electric motors', 'Induced potential, transformers and the National Grid']
                    },
                    {
                        section: '8. Space Physics (Higher Tier)',
                        items: ['Our solar system', 'The life cycle of a star', 'Orbital motion, natural and artificial satellites', 'Red-shift']
                    }
                ]
            },
            maths: {
                name: 'Maths',
                topics: [
                    {
                        section: '1. Number',
                        items: ['Order of operations (BIDMAS)', 'Place value and ordering integers, decimals', 'Four operations with integers', 'Negative numbers', 'Factors, multiples, primes', 'HCF and LCM', 'Product of prime factors', 'Operations with fractions', 'Operations with decimals', 'Fractions, decimals and percentages', 'Percentage of an amount', 'Percentage increase and decrease', 'Repeated percentage change', 'Reverse percentages', 'Powers and roots', 'Index laws', 'Zero, negative and fractional indices (Higher)', 'Standard form', 'Calculating with standard form', 'Surds (Higher)', 'Rationalising denominators (Higher)', 'Upper and lower bounds', 'Estimation and approximation', 'Rounding', 'Significant figures']
                    },
                    {
                        section: '2. Algebra',
                        items: ['Algebraic notation and vocabulary', 'Substitution', 'Simplifying expressions', 'Expanding brackets', 'Factorising', 'Solving linear equations', 'Equations with brackets', 'Equations with fractions', 'Equations with unknowns on both sides', 'Changing the subject of a formula', 'Linear sequences', 'nth term of a sequence', 'Quadratic sequences (Higher)', 'Geometric sequences (Higher)', 'Fibonacci sequences', 'Straight line graphs y = mx + c', 'Finding gradient and y-intercept', 'Drawing graphs', 'Real-life graphs', 'Quadratic graphs', 'Cubic and reciprocal graphs (Higher)', 'Expanding double brackets', 'Factorising quadratics', 'Solving quadratic equations', 'The quadratic formula (Higher)', 'Completing the square (Higher)', 'Simultaneous equations (elimination)', 'Simultaneous equations (substitution)', 'Simultaneous equations (one quadratic) (Higher)', 'Linear inequalities', 'Quadratic inequalities (Higher)', 'Graphical inequalities', 'Algebraic fractions (Higher)', 'Proof (Higher)']
                    },
                    {
                        section: '3. Ratio, Proportion and Rates of Change',
                        items: ['Simplifying ratios', 'Sharing in a ratio', 'Ratio and fractions', 'Using ratios', 'Direct proportion', 'Inverse proportion', 'Direct proportion graphs', 'Inverse proportion graphs (Higher)', 'Compound measures (speed, density)', 'Pressure', 'Conversions (metric and imperial)', 'Currency conversions', 'Compound interest', 'Exponential growth and decay (Higher)']
                    },
                    {
                        section: '4. Geometry and Measures',
                        items: ['Angles: acute, obtuse, reflex', 'Angles on a straight line', 'Angles at a point', 'Vertically opposite angles', 'Angles in triangles', 'Angles in quadrilaterals', 'Angles in polygons', 'Parallel lines and alternate/corresponding angles', 'Properties of triangles', 'Properties of quadrilaterals', 'Congruent shapes', 'Similar shapes', 'Perimeter', 'Area of rectangles and triangles', 'Area of parallelograms and trapeziums', 'Area of circles', 'Area of compound shapes', 'Volume of cuboids', 'Volume of prisms', 'Volume of cylinders', 'Volume of pyramids, cones, spheres (Higher)', 'Surface area of cuboids and prisms', 'Surface area of cylinders, cones, spheres (Higher)', 'Pythagoras\' theorem', 'Pythagoras in 3D (Higher)', 'Trigonometry (sin, cos, tan)', 'Finding angles using trigonometry', 'Exact trig values (Higher)', 'Sine rule (Higher)', 'Cosine rule (Higher)', 'Area of a triangle (¬ΩabsinC) (Higher)', 'Trigonometry in 3D (Higher)', 'Vectors', 'Vector arithmetic (Higher)', 'Column vectors', 'Translations', 'Reflections', 'Rotations', 'Enlargements', 'Combinations of transformations', 'Constructions (perpendicular bisector, angle bisector)', 'Loci', 'Bearings', 'Circle theorems (Higher)', 'Plans and elevations']
                    },
                    {
                        section: '5. Probability',
                        items: ['Probability scale', 'Calculating probabilities', 'Experimental probability', 'Relative frequency', 'Expected frequency', 'Two-way tables', 'Sample space diagrams', 'Tree diagrams', 'Independent events', 'Conditional probability (Higher)', 'Venn diagrams', 'Set notation (Higher)']
                    },
                    {
                        section: '6. Statistics',
                        items: ['Mean, median, mode', 'Range', 'Averages from frequency tables', 'Averages from grouped data', 'Bar charts', 'Pictograms', 'Pie charts', 'Stem and leaf diagrams', 'Frequency polygons', 'Time series graphs', 'Scatter graphs', 'Line of best fit', 'Correlation', 'Cumulative frequency', 'Quartiles and interquartile range', 'Box plots', 'Histograms (Higher)', 'Comparing distributions']
                    }
                ]
            },
            geography: {
                name: 'Geography',
                topics: [
                    {
                        section: '1. The Challenge of Natural Hazards',
                        items: ['Natural hazards', 'Tectonic hazards', 'Weather hazards', 'Climate change']
                    },
                    {
                        section: '2. The Living World',
                        items: ['Ecosystems', 'Tropical rainforests', 'Hot deserts', 'Cold environments']
                    },
                    {
                        section: '3. Physical Landscapes in the UK',
                        items: ['UK physical landscapes', 'Coastal landscapes', 'River landscapes', 'Glacial landscapes']
                    },
                    {
                        section: '4. Urban Issues and Challenges',
                        items: ['Urban issues and challenges', 'Urban change in UK cities', 'Sustainable urban development']
                    },
                    {
                        section: '5. The Changing Economic World',
                        items: ['Economic development', 'Changing economic world', 'Economic futures in the UK']
                    },
                    {
                        section: '6. The Challenge of Resource Management',
                        items: ['Resource management', 'Food', 'Water', 'Energy']
                    },
                    {
                        section: '7. Geographical Skills',
                        items: ['Cartographic skills', 'Graphical skills', 'Numerical skills', 'Statistical skills']
                    }
                ]
            },
            french: {
                name: 'French',
                topics: [
                    {
                        section: '1. Identity and Culture',
                        items: ['Me, my family and friends', 'Technology in everyday life', 'Free-time activities', 'Customs and festivals']
                    },
                    {
                        section: '2. Local, National, International Areas of Interest',
                        items: ['Home, town, neighbourhood and region', 'Social issues', 'Global issues', 'Travel and tourism']
                    },
                    {
                        section: '3. Current and Future Study and Employment',
                        items: ['My studies', 'Life at school/college', 'Education post-16', 'Jobs, career choices and ambitions']
                    },
                    {
                        section: '4. Grammar',
                        items: ['Present tense (regular and irregular)', 'Perfect tense', 'Imperfect tense', 'Future tense', 'Conditional', 'Subjunctive (Higher tier)']
                    }
                ]
            },
            english_lang: {
                name: 'English Language',
                topics: [
                    {
                        section: 'Paper 1: Explorations in Creative Reading and Writing',
                        items: ['Reading fiction texts', 'Analysing language and structure', 'Evaluating texts', 'Creative writing (descriptive)', 'Creative writing (narrative)']
                    },
                    {
                        section: 'Paper 2: Writers\' Viewpoints and Perspectives',
                        items: ['Reading non-fiction texts', 'Comparing writers\' viewpoints', 'Analysing how writers achieve effects', 'Writing to present a viewpoint', 'Transactional writing']
                    },
                    {
                        section: 'Spoken Language (Non-exam)',
                        items: ['Presenting information and ideas', 'Responding to questions and feedback', 'Standard English and formal register']
                    }
                ]
            },
            english_lit: {
                name: 'English Literature',
                topics: [
                    {
                        section: 'Paper 1: Shakespeare and the 19th Century Novel',
                        items: ['Shakespeare play (your set text)', 'Understanding Shakespeare\'s language', 'Shakespeare\'s themes and context', '19th century novel (your set text)', 'Victorian context and society']
                    },
                    {
                        section: 'Paper 2: Modern Texts and Poetry',
                        items: ['Modern prose or drama (your set text)', 'Modern text themes and context', 'Power and Conflict poetry anthology', 'Comparing poems', 'Unseen poetry', 'Comparing unseen poems']
                    }
                ]
            },
            history: {
                name: 'History',
                topics: [
                    {
                        section: 'Paper 1: Thematic Study and Historic Environment',
                        items: ['Thematic study (your chosen option)', 'Historic environment study']
                    },
                    {
                        section: 'Paper 2: Period Study and British Depth Study',
                        items: ['Period study (your chosen option)', 'British depth study (your chosen option)']
                    },
                    {
                        section: 'Paper 3: Modern Depth Study',
                        items: ['Modern depth study (your chosen option)', 'Source analysis skills', 'Making historical interpretations']
                    },
                    {
                        section: 'Key Skills',
                        items: ['Analysing historical sources', 'Evaluating interpretations', 'Extended writing and essay skills', 'Using historical knowledge']
                    }
                ]
            },
            drama: {
                name: 'Drama',
                topics: [
                    {
                        section: 'Component 1: Devising Drama (30%)',
                        items: ['Understanding the devising process', 'Researching stimuli and practitioner influences', 'Developing and refining devised work', 'Performing devised work', 'Evaluating own devised performance', 'Portfolio of supporting evidence']
                    },
                    {
                        section: 'Component 2: Presenting and Performing Texts (30%)',
                        items: ['Performing from a performance text', 'Understanding script and character', 'Rehearsal techniques and processes', 'Performance skills (vocal)', 'Performance skills (physical)', 'Working effectively with others']
                    },
                    {
                        section: 'Component 3: Drama Performance and Response (40%)',
                        items: ['Section A: Live Theatre Evaluation', 'Analysing and evaluating live theatre', 'Understanding theatrical roles and terminology', 'Section B: Page to Stage - Performing', 'Section B: Page to Stage - Designing', 'Understanding set design', 'Understanding lighting design', 'Understanding sound design', 'Understanding costume design', 'Knowledge of drama practitioners', 'Stanislavski techniques', 'Brecht techniques', 'Artaud techniques', 'Understanding genre, style and form']
                    },
                    {
                        section: 'Practical Skills',
                        items: ['Voice projection and clarity', 'Physicality and movement', 'Use of space and staging', 'Creating character', 'Ensemble work', 'Improvisation techniques', 'Directorial concepts']
                    }
                ]
            }
        };

        // ============= STATE MANAGEMENT =============
        let currentSubject = null;
        let progressData = {};
        let activeFilters = [];
        let currentNotesTopic = null;

        // Timer state
        let timerState = {
            running: false,
            paused: false,
            totalSeconds: 1500,
            remainingSeconds: 1500,
            topic: null,
            type: 'Study'
        };
        let timerInterval = null;

        // ============= HELPER FUNCTIONS =============
        function getTopicKey(section, topic) {
            return `${section}|${topic}`;
        }

        function getSubjectData(subjectKey) {
            return curriculum[subjectKey];
        }

        // ============= TOPIC RENDERING =============
        function showSubject(subjectKey) {
            currentSubject = subjectKey;
            const subject = getSubjectData(subjectKey);
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-view="${subjectKey}"]`).classList.add('active');

            document.getElementById('overviewView').style.display = 'none';
            document.getElementById('analyticsView').classList.remove('active');
            document.getElementById('topicListView').classList.add('active');

            renderTopics();
        }

        function renderTopics() {
            if (!currentSubject) {
                renderOverview();
                return;
            }

            const container = document.getElementById('topicsContainer');
            const subject = getSubjectData(currentSubject);
            
            if (!progressData[currentSubject]) {
                progressData[currentSubject] = {};
            }

            let html = '';
            subject.topics.forEach(section => {
                html += `
                    <div class="section">
                        <div class="section-header">${section.section}</div>
                `;

                section.items.forEach(item => {
                    const key = getTopicKey(section.section, item);
                    const topicData = progressData[currentSubject][key] || { status: 'none', notes: '', sessions: [], totalMinutes: 0 };
                    
                    // Format completion date if exists
                    let completionInfo = '';
                    if (topicData.completed_at && topicData.status === 'green') {
                        const completedDate = new Date(topicData.completed_at);
                        const formattedDate = completedDate.toLocaleString('en-GB', {
                            day: '2-digit',
                            month: 'short',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        const completedBy = topicData.completed_by || 'Unknown';
                        completionInfo = `
                            <div style="font-size: 0.85em; color: #28a745; margin-top: 5px;">
                                ‚úÖ Completed: ${formattedDate}
                                ${completedBy !== currentUser?.email ? ` by ${completedBy.split('@')[0]}` : ''}
                            </div>
                        `;
                    }

                    html += `
                        <div class="topic-item">
                            <div class="topic-name">
                                ${item}
                                ${completionInfo}
                            </div>
                            <div class="topic-controls">
                                <button class="status-btn red ${topicData.status === 'red' ? 'active' : ''}" 
                                    data-subject="${currentSubject}" data-section="${section.section.replace(/"/g, '&quot;')}" data-item="${item.replace(/"/g, '&quot;')}" data-status="red"
                                    onclick="updateStatusFromBtn(this)">
                                    Need Work
                                </button>
                                <button class="status-btn amber ${topicData.status === 'amber' ? 'active' : ''}"
                                    data-subject="${currentSubject}" data-section="${section.section.replace(/"/g, '&quot;')}" data-item="${item.replace(/"/g, '&quot;')}" data-status="amber"
                                    onclick="updateStatusFromBtn(this)">
                                    Getting There
                                </button>
                                <button class="status-btn green ${topicData.status === 'green' ? 'active' : ''}"
                                    data-subject="${currentSubject}" data-section="${section.section.replace(/"/g, '&quot;')}" data-item="${item.replace(/"/g, '&quot;')}" data-status="green"
                                    onclick="updateStatusFromBtn(this)">
                                    Confident
                                </button>
                                <button class="action-btn secondary"
                                    data-subject="${currentSubject}" data-section="${section.section.replace(/"/g, '&quot;')}" data-item="${item.replace(/"/g, '&quot;')}"
                                    onclick="openTimerFromBtn(this)">
                                    ‚è±Ô∏è Timer
                                </button>
                                <button class="action-btn"
                                    data-subject="${currentSubject}" data-section="${section.section.replace(/"/g, '&quot;')}" data-item="${item.replace(/"/g, '&quot;')}"
                                    onclick="openNotesFromBtn(this)">
                                    üìù Notes ${topicData.notes ? '‚úì' : ''}
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            });

            container.innerHTML = html;
            filterTopics();
        }

        function updateStatusFromBtn(btn) {
            const subject = btn.dataset.subject;
            const section = btn.dataset.section;
            const item = btn.dataset.item;
            const status = btn.dataset.status;
            updateStatus(subject, section, item, status);
        }

        function openTimerFromBtn(btn) {
            const subject = btn.dataset.subject;
            const section = btn.dataset.section;
            const item = btn.dataset.item;
            openTimer(subject, section, item);
        }

        function openNotesFromBtn(btn) {
            const subject = btn.dataset.subject;
            const section = btn.dataset.section;
            const item = btn.dataset.item;
            openNotes(subject, section, item);
        }

        function updateStatus(subject, section, topic, status) {
            const key = getTopicKey(section, topic);
            
            if (!progressData[subject]) {
                progressData[subject] = {};
            }
            if (!progressData[subject][key]) {
                progressData[subject][key] = { status: 'none', notes: '', sessions: [], totalMinutes: 0 };
            }

            const currentStatus = progressData[subject][key].status;
            const previousStatus = currentStatus; // Capture before we change it
            console.log('üîÑ Status change requested:', { subject, topic, currentStatus, requestedStatus: status });

            if (currentStatus === status) {
                // Toggle off - clicking the same button again
                console.log('‚ö™ Toggling off - same button clicked');
                progressData[subject][key].status = 'none';
                status = 'none';
            } else {
                // Change to new status
                console.log('üîµ Changing status to:', status);
                progressData[subject][key].status = status;
            }

            // Save and then refresh analytics if on analytics tab
            // Pass previousStatus so saveTopicProgress knows what the old status was
            saveTopicProgress(subject, section, topic, status, progressData[subject][key].notes, previousStatus)
                .then(() => {
                    console.log('‚úÖ Status saved successfully');
                    // Refresh analytics if analytics view is active
                    const analyticsView = document.getElementById('analyticsView');
                    if (analyticsView && analyticsView.classList.contains('active')) {
                        console.log('üìä Refreshing analytics after status change...');
                        setTimeout(() => {
                            if (currentUser && currentUser.email) {
                                loadUserAnalytics(currentUser.email);
                            }
                        }, 500);
                    }
                })
                .catch((error) => {
                    console.error('‚ùå Error in updateStatus:', error);
                });
            
            renderTopics();        }

        // ============= NOTES MODAL =============
        function openNotes(subject, section, topic) {
            currentNotesTopic = { subject, section, topic };
            const key = getTopicKey(section, topic);
            const topicData = progressData[subject]?.[key] || { notes: '' };

            document.getElementById('notesTopicName').textContent = `${curriculum[subject].name} - ${section}: ${topic}`;
            document.getElementById('notesTextarea').value = topicData.notes || '';
            document.getElementById('notesModal').classList.add('active');
        }

        function closeNotesModal() {
            document.getElementById('notesModal').classList.remove('active');
            currentNotesTopic = null;
        }

        function saveNotes() {
            if (!currentNotesTopic) return;

            const { subject, section, topic } = currentNotesTopic;
            const notes = document.getElementById('notesTextarea').value;
            const key = getTopicKey(section, topic);

            if (!progressData[subject]) {
                progressData[subject] = {};
            }
            if (!progressData[subject][key]) {
                progressData[subject][key] = { status: 'none', notes: '', sessions: [], totalMinutes: 0 };
            }

            progressData[subject][key].notes = notes;
            saveTopicProgress(subject, section, topic, progressData[subject][key].status, notes);
            
            closeNotesModal();
            renderTopics();
        }

        // ============= OVERVIEW & ANALYTICS =============
        function renderOverview() {
            const stats = calculateOverallStats();
            
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-value">${stats.totalTopics}</div>
                    <div class="stat-label">Total Topics</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #4caf50;">${stats.greenTopics}</div>
                    <div class="stat-label">Confident</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #ff9800;">${stats.amberTopics}</div>
                    <div class="stat-label">Getting There</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #f44336;">${stats.redTopics}</div>
                    <div class="stat-label">Need Work</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.percentage}%</div>
                    <div class="stat-label">Overall Progress</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatMinutes(stats.totalMinutes)}</div>
                    <div class="stat-label">Study Time</div>
                </div>
            `;

            document.getElementById('statsGrid').innerHTML = statsHtml;
            renderSubjectBreakdown();
        }

        function calculateOverallStats() {
            let totalTopics = 0;
            let greenTopics = 0;
            let amberTopics = 0;
            let redTopics = 0;
            let totalMinutes = 0;

            Object.keys(curriculum).forEach(subjectKey => {
                const subject = curriculum[subjectKey];
                subject.topics.forEach(section => {
                    section.items.forEach(item => {
                        totalTopics++;
                        const key = getTopicKey(section.section, item);
                        const topicData = progressData[subjectKey]?.[key];
                        
                        if (topicData) {
                            if (topicData.status === 'green') greenTopics++;
                            else if (topicData.status === 'amber') amberTopics++;
                            else if (topicData.status === 'red') redTopics++;
                            totalMinutes += topicData.totalMinutes || 0;
                        }
                    });
                });
            });

            const completedTopics = greenTopics + amberTopics + redTopics;
            const percentage = totalTopics > 0 ? Math.round((completedTopics / totalTopics) * 100) : 0;

            return {
                totalTopics,
                greenTopics,
                amberTopics,
                redTopics,
                notStarted: totalTopics - completedTopics,
                percentage,
                totalMinutes
            };
        }

        function calculateSubjectStats(subjectKey) {
            const subject = curriculum[subjectKey];
            let total = 0;
            let green = 0;
            let amber = 0;
            let red = 0;

            subject.topics.forEach(section => {
                section.items.forEach(item => {
                    total++;
                    const key = getTopicKey(section.section, item);
                    const topicData = progressData[subjectKey]?.[key];
                    
                    if (topicData) {
                        if (topicData.status === 'green') green++;
                        else if (topicData.status === 'amber') amber++;
                        else if (topicData.status === 'red') red++;
                    }
                });
            });

            const completed = green + amber + red;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

            return { total, green, amber, red, percentage };
        }

        function formatMinutes(minutes) {
            if (minutes < 60) return `${minutes}m`;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
        }

        function renderSubjectBreakdown() {
            const breakdown = document.getElementById('subjectBreakdown');
            breakdown.innerHTML = '';

            Object.keys(curriculum).forEach(subjectKey => {
                const subject = curriculum[subjectKey];
                const stats = calculateSubjectStats(subjectKey);

                const row = document.createElement('div');
                row.className = 'subject-row';

                const greenWidth = stats.total > 0 ? (stats.green / stats.total) * 100 : 0;
                const amberWidth = stats.total > 0 ? (stats.amber / stats.total) * 100 : 0;
                const redWidth = stats.total > 0 ? (stats.red / stats.total) * 100 : 0;

                row.innerHTML = `
                    <div class="subject-row-header">
                        <h4>${subject.name}</h4>
                        <span class="subject-percentage">${stats.percentage}% Complete</span>
                    </div>
                    <div class="status-bars">
                        ${greenWidth > 0 ? `<div class="status-bar green" style="width: ${greenWidth}%">${stats.green}</div>` : ''}
                        ${amberWidth > 0 ? `<div class="status-bar amber" style="width: ${amberWidth}%">${stats.amber}</div>` : ''}
                        ${redWidth > 0 ? `<div class="status-bar red" style="width: ${redWidth}%">${stats.red}</div>` : ''}
                    </div>
                `;

                breakdown.appendChild(row);
            });
        }

        async function renderAnalytics() {
            const content = document.getElementById('analyticsContent');
            
            // Show loading state
            content.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">Loading analytics data...</div>';
            
            try {
                // Get list of users in this family
                const { data: users, error: usersError } = await supabaseClient
                    .from('user_profiles')
                    .select('email, role')
                    .eq('family_id', FAMILY_ID);
                
                if (usersError) throw usersError;
                
                if (!users || users.length === 0) {
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">No users found</div>';
                    return;
                }
                
                // Create user selector and analytics content
                let html = `
                    <div style="margin-bottom: 30px;">
                        <label for="analyticsUserSelect" style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                            Select User to View Analytics:
                        </label>
                        <select id="analyticsUserSelect" onchange="loadUserAnalytics(this.value)" style="
                            width: 100%;
                            max-width: 400px;
                            padding: 12px;
                            border: 2px solid #e0e0e0;
                            border-radius: 8px;
                            font-size: 16px;
                            background: white;
                            cursor: pointer;
                        ">
                            <option value="">-- Select a user --</option>
                            ${users.map(user => `
                                <option value="${user.email}">${user.email} (${user.role})</option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <div id="userAnalyticsContent" style="display: none;">
                        <!-- User-specific analytics will be loaded here -->
                    </div>
                `;
                
                content.innerHTML = html;
                
                // Auto-select current user if they're in the list
                const select = document.getElementById('analyticsUserSelect');
                if (currentUser && users.find(u => u.email === currentUser.email)) {
                    select.value = currentUser.email;
                    await loadUserAnalytics(currentUser.email);
                }
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                content.innerHTML = `
                    <div style="background: #fee; color: #c00; padding: 20px; border-radius: 10px;">
                        <strong>Error loading analytics:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function loadUserAnalytics(email) {
            if (!email) {
                document.getElementById('userAnalyticsContent').style.display = 'none';
                return;
            }
            
            const container = document.getElementById('userAnalyticsContent');
            container.style.display = 'block';
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Loading...</div>';
            
            try {
                // Load session data
                const { data: sessions, error: sessionsError } = await supabaseClient
                    .from('user_sessions')
                    .select('*')
                    .eq('email', email)
                    .eq('family_id', FAMILY_ID)
                    .order('login_time', { ascending: false })
                    .limit(20);
                
                if (sessionsError) throw sessionsError;
                
                // Load topic time data
                const { data: topicTime, error: topicTimeError } = await supabaseClient
                    .from('topic_time_tracking')
                    .select('*')
                    .eq('email', email)
                    .eq('family_id', FAMILY_ID)
                    .order('tracked_at', { ascending: false });
                
                if (topicTimeError) throw topicTimeError;
                
                // Load completion history
                console.log('üìä Loading completion history for:', email, 'family:', FAMILY_ID);
                const { data: completions, error: completionsError } = await supabaseClient
                    .from('completion_history')
                    .select('*')
                    .eq('email', email)
                    .eq('family_id', FAMILY_ID)
                    .eq('status', 'green')
                    .order('completed_at', { ascending: false })
                    .limit(20);
                
                console.log('Completions loaded:', completions ? completions.length : 0, 'records');
                if (completions && completions.length > 0) {
                    console.log('Sample completion:', completions[0]);
                } else {
                    console.warn('‚ö†Ô∏è NO COMPLETIONS FOUND! Searching for:');
                    console.warn('  - email:', email);
                    console.warn('  - family_id:', FAMILY_ID);
                    console.warn('  - status: green');
                    console.warn('Check Supabase to see if records exist with these exact values.');
                }
                
                if (completionsError) {
                    console.error('‚ùå Error loading completion history:', completionsError);
                    console.warn('Completion history not available:', completionsError);
                }
                
                // Calculate stats
                const totalSessions = sessions.length;
                const totalMinutes = topicTime.reduce((sum, t) => sum + (t.minutes_spent || 0), 0);
                const totalCompletions = completions ? completions.length : 0;
                
                // Calculate average session duration
                let avgSessionMinutes = 0;
                if (sessions.length > 0) {
                    const completedSessions = sessions.filter(s => s.logout_time);
                    if (completedSessions.length > 0) {
                        const totalSessionTime = completedSessions.reduce((sum, s) => {
                            const login = new Date(s.login_time);
                            const logout = new Date(s.logout_time);
                            return sum + (logout - login);
                        }, 0);
                        avgSessionMinutes = Math.round(totalSessionTime / completedSessions.length / 60000);
                    }
                }
                
                // Aggregate time by topic
                const timeByTopic = {};
                topicTime.forEach(t => {
                    const key = `${t.subject} > ${t.section} > ${t.topic}`;
                    if (!timeByTopic[key]) {
                        timeByTopic[key] = 0;
                    }
                    timeByTopic[key] += t.minutes_spent;
                });
                
                // Sort topics by time spent
                const sortedTopics = Object.entries(timeByTopic)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                // Render analytics
                let html = `
                    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="stat-card" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold; color: #667eea;">${totalSessions}</div>
                            <div style="color: #666; margin-top: 5px;">Total Sessions</div>
                        </div>
                        <div class="stat-card" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold; color: #28a745;">${formatMinutes(totalMinutes)}</div>
                            <div style="color: #666; margin-top: 5px;">Study Time</div>
                        </div>
                        <div class="stat-card" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold; color: #ff9800;">${avgSessionMinutes}</div>
                            <div style="color: #666; margin-top: 5px;">Avg Session (min)</div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 20px;">üìÖ Recent Login Sessions</h3>
                        ${sessions.length === 0 ? 
                            '<p style="text-align: center; color: #999; padding: 20px;">No sessions recorded yet. Sessions are tracked from deployment onwards.</p>' :
                            `<div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Login Time</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Logout Time</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Duration</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sessions.map(session => {
                                            const loginTime = new Date(session.login_time).toLocaleString();
                                            const logoutTime = session.logout_time ? new Date(session.logout_time).toLocaleString() : 'Still active';
                                            let duration = '---';
                                            if (session.logout_time) {
                                                const login = new Date(session.login_time);
                                                const logout = new Date(session.logout_time);
                                                const minutes = Math.round((logout - login) / 60000);
                                                duration = formatMinutes(minutes);
                                            }
                                            return `
                                                <tr style="border-bottom: 1px solid #dee2e6;">
                                                    <td style="padding: 12px; color: #495057;">${loginTime}</td>
                                                    <td style="padding: 12px; color: #495057;">${logoutTime}</td>
                                                    <td style="padding: 12px; color: #495057; font-weight: 600;">${duration}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>`
                        }
                    </div>
                    
                    <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 20px;">‚è±Ô∏è Time Spent by Topic</h3>
                        ${topicTime.length === 0 ?
                            '<p style="text-align: center; color: #999; padding: 20px;">No time tracking data yet. Use the timer feature to track study sessions.</p>' :
                            `<div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Topic</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Session Type</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Start Time</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Duration</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${topicTime.slice(0, 20).map(session => {
                                            const topicName = `${session.subject} > ${session.section} > ${session.topic}`;
                                            const startTime = new Date(session.tracked_at).toLocaleString('en-GB', {
                                                day: '2-digit',
                                                month: 'short',
                                                year: 'numeric',
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            });
                                            const endTime = new Date(new Date(session.tracked_at).getTime() + (session.minutes_spent * 60000)).toLocaleString('en-GB', {
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            });
                                            const sessionTypeLabel = session.session_type === 'study' ? 'üìñ Study' : 
                                                                     session.session_type === 'practice' ? '‚úèÔ∏è Practice' : 
                                                                     session.session_type === 'revision' ? 'üîÑ Revision' : '‚è±Ô∏è Other';
                                            return `
                                                <tr style="border-bottom: 1px solid #dee2e6;">
                                                    <td style="padding: 12px; color: #495057; font-weight: 500;">${topicName}</td>
                                                    <td style="padding: 12px; color: #495057;">${sessionTypeLabel}</td>
                                                    <td style="padding: 12px; color: #495057;">${startTime} - ${endTime}</td>
                                                    <td style="padding: 12px; color: #667eea; font-weight: 600;">${formatMinutes(session.minutes_spent)}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                                ${topicTime.length > 20 ? `<p style="text-align: center; color: #999; margin-top: 15px; font-size: 0.9em;">Showing 20 most recent sessions out of ${topicTime.length} total</p>` : ''}
                                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <h4 style="color: #667eea; margin-bottom: 10px;">üìä Summary by Topic</h4>
                                    ${sortedTopics.slice(0, 10).map(([topic, minutes]) => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
                                            <div style="flex: 1; color: #495057;">${topic}</div>
                                            <div style="font-weight: 600; color: #667eea; margin-left: 20px;">${formatMinutes(minutes)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>`
                        }
                    </div>
                    
                    <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: #667eea; margin-bottom: 20px;">üéØ Topics Completed</h3>
                        <div id="topicsCompletedContainer"></div>
                    </div>
                `;
                
                container.innerHTML = html;
                
                // Render completions with grouping
                renderCompletionsGrouped(completions);
                
            } catch (error) {
                console.error('Error loading user analytics:', error);
                container.innerHTML = `
                    <div style="background: #fee; color: #c00; padding: 20px; border-radius: 10px;">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }
        
        function renderCompletionsGrouped(completions) {
            const container = document.getElementById('topicsCompletedContainer');
            if (!container) return;
            
            if (!completions || completions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No completed topics yet. Mark topics as "Confident" (green) to track completions.</p>';
                return;
            }
            
            // Group by subject
            const bySubject = {};
            completions.forEach(completion => {
                if (!bySubject[completion.subject]) {
                    bySubject[completion.subject] = [];
                }
                bySubject[completion.subject].push(completion);
            });
            
            const subjects = Object.keys(bySubject).sort();
            
            let html = '<div>';
            subjects.forEach((subject, index) => {
                const subjectCompletions = bySubject[subject];
                const subjectId = subject.replace(/[^a-zA-Z0-9]/g, '_');
                const isFirstSubject = index === 0;
                
                html += `
                    <div style="margin-bottom: 15px; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;">
                        <div 
                            onclick="toggleSubjectCompletions('${subjectId}')"
                            style="background: #f8f9fa; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;"
                            onmouseover="this.style.background='#e9ecef'"
                            onmouseout="this.style.background='#f8f9fa'"
                        >
                            <div>
                                <strong style="color: #667eea; font-size: 1.1em;">${subject.replace(/'/g, "&apos;").replace(/"/g, "&quot;")}</strong>
                                <span style="color: #999; margin-left: 10px; font-size: 0.9em;">(${subjectCompletions.length} topic${subjectCompletions.length === 1 ? '' : 's'})</span>
                            </div>
                            <span id="arrow_${subjectId}" style="color: #667eea; font-size: 1.2em; transition: transform 0.3s;">${isFirstSubject ? '‚ñº' : '‚ñ∂'}</span>
                        </div>
                        <div id="content_${subjectId}" style="display: ${isFirstSubject ? 'block' : 'none'};">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #fafbfc; border-bottom: 2px solid #dee2e6;">
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Section</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Topic</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Completed</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                
                subjectCompletions.forEach(completion => {
                    const completedDate = new Date(completion.completed_at).toLocaleString('en-GB', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const escapedSection = completion.section.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                    const escapedTopic = completion.topic.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                    html += `
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 12px; color: #495057; font-weight: 500;">${escapedSection}</td>
                            <td style="padding: 12px; color: #495057;">${escapedTopic}</td>
                            <td style="padding: 12px; color: #28a745; font-weight: 600;">${completedDate}</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function toggleSubjectCompletions(subjectId) {
            const content = document.getElementById('content_' + subjectId);
            const arrow = document.getElementById('arrow_' + subjectId);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                arrow.textContent = '‚ñ∂';
            }
        }

        function generateStrengths() {
            const strengths = [];
            
            Object.keys(curriculum).forEach(subjectId => {
                const stats = calculateSubjectStats(subjectId);
                if (stats.percentage >= 70) {
                    strengths.push({
                        subject: curriculum[subjectId].name,
                        percentage: stats.percentage
                    });
                }
            });

            if (strengths.length === 0) {
                return '<p style="text-align: center; color: #999;">Keep working - strengths will appear as you make progress!</p>';
            }

            strengths.sort((a, b) => b.percentage - a.percentage);

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
            strengths.forEach(strength => {
                html += `
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #28a745;">
                        <div style="font-size: 1.3em; font-weight: bold; color: #155724;">${strength.subject}</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: #28a745; margin-top: 5px;">${strength.percentage}%</div>
                        <div style="color: #155724; margin-top: 5px;">Confident</div>
                    </div>
                `;
            });
            html += '</div>';

            return html;
        }

        function generateRecommendations(stats) {
            const recommendations = [];
            
            if (stats.redTopics > 0) {
                recommendations.push(`Focus on the ${stats.redTopics} topics marked as "Need Work" - these require immediate attention.`);
            }
            
            if (stats.amberTopics > stats.greenTopics) {
                recommendations.push(`Many topics are in the "Getting There" stage. Regular practice will help move these to confident.`);
            }
            
            if (stats.notStarted > stats.totalTopics * 0.3) {
                recommendations.push(`${stats.notStarted} topics haven't been started yet. Create a study plan to cover all topics before exams.`);
            }
            
            if (stats.totalMinutes < 60) {
                recommendations.push('Consider using the timer feature more regularly to build consistent study habits.');
            }
            
            const avgMinutesPerGreen = stats.greenTopics > 0 ? Math.round(stats.totalMinutes / stats.greenTopics) : 0;
            if (avgMinutesPerGreen > 0 && avgMinutesPerGreen < 30) {
                recommendations.push(`Average study time per mastered topic is ${avgMinutesPerGreen} minutes. Consider spending more time on each topic for deeper understanding.`);
            }
            
            if (recommendations.length === 0) {
                recommendations.push('Great progress! Keep up the consistent revision schedule.');
                recommendations.push('Consider doing practice papers to test understanding.');
            }

            return `
                <div class="recommendations">
                    <h4>üí° Recommendations for Improvement</h4>
                    <ul>
                        ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        // ============= VIEW SWITCHING =============
        function switchView(view) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-view="${view}"]`).classList.add('active');

            if (view === 'overview') {
                document.getElementById('overviewView').style.display = 'block';
                document.getElementById('analyticsView').classList.remove('active');
                document.getElementById('topicListView').classList.remove('active');
                currentSubject = null;
                renderOverview();
            } else if (view === 'analytics') {
                document.getElementById('overviewView').style.display = 'none';
                document.getElementById('topicListView').classList.remove('active');
                document.getElementById('analyticsView').classList.add('active');
                renderAnalytics();
            }
        }

        // ============= FILTERING =============
        function toggleFilter(status) {
            const btn = document.querySelector(`[data-status="${status}"]`);
            
            if (activeFilters.includes(status)) {
                activeFilters = activeFilters.filter(f => f !== status);
                btn.classList.remove('active');
            } else {
                activeFilters.push(status);
                btn.classList.add('active');
            }

            filterTopics();
        }

        function filterTopics() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            if (!document.getElementById('topicListView').classList.contains('active')) {
                return;
            }

            document.querySelectorAll('.topic-item').forEach(item => {
                const topicName = item.querySelector('.topic-name').textContent.toLowerCase();
                const matchesSearch = topicName.includes(searchTerm);
                
                let status = 'none';
                if (item.querySelector('.status-btn.red.active')) status = 'red';
                else if (item.querySelector('.status-btn.amber.active')) status = 'amber';
                else if (item.querySelector('.status-btn.green.active')) status = 'green';
                
                const matchesFilter = activeFilters.length === 0 || activeFilters.includes(status);
                
                item.style.display = matchesSearch && matchesFilter ? 'flex' : 'none';
            });
        }

        // ============= TIMER FUNCTIONS =============
        function openTimer(subject, section, topic) {
            timerState.topic = { subject, section, topic };
            timerState.running = false;
            timerState.paused = false;
            timerState.remainingSeconds = timerState.totalSeconds;

            document.getElementById('timerTopicName').textContent = topic;
            document.getElementById('timerType').textContent = `${curriculum[subject].name} - ${section}`;
            document.getElementById('timerPanel').classList.add('active');
            
            updateTimerDisplay();
            resetTimerButtons();
        }

        function closeTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            document.getElementById('timerPanel').classList.remove('active');
            resetTimerState();
        }

        function setTimerPreset(minutes) {
            if (timerState.running) return;
            
            timerState.totalSeconds = minutes * 60;
            timerState.remainingSeconds = timerState.totalSeconds;
            updateTimerDisplay();
        }

        function startTimer() {
            if (timerState.running) return;
            
            timerState.running = true;
            timerState.paused = false;
            
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'inline-block';

            timerInterval = setInterval(() => {
                if (timerState.remainingSeconds > 0) {
                    timerState.remainingSeconds--;
                    updateTimerDisplay();
                } else {
                    completeTimer();
                }
            }, 1000);
        }

        function pauseTimer() {
            timerState.running = false;
            timerState.paused = true;
            clearInterval(timerInterval);
            
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('startBtn').textContent = 'Resume';
        }

        function stopTimer() {
            if (confirm('Stop timer and save session?')) {
                const completedSeconds = timerState.totalSeconds - timerState.remainingSeconds;
                if (completedSeconds > 0) {
                    saveTimerSession(
                        timerState.topic.subject,
                        timerState.topic.section,
                        timerState.topic.topic,
                        timerState.type,
                        completedSeconds
                    );
                }
                closeTimer();
            }
        }

        function completeTimer() {
            clearInterval(timerInterval);
            
            saveTimerSession(
                timerState.topic.subject,
                timerState.topic.section,
                timerState.topic.topic,
                timerState.type,
                timerState.totalSeconds
            );

            alert('Timer completed! Great work! üéâ');
            closeTimer();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timerState.remainingSeconds / 60);
            const seconds = timerState.remainingSeconds % 60;
            document.getElementById('timerTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            const circumference = 2 * Math.PI * 90;
            const progress = (timerState.remainingSeconds / timerState.totalSeconds) * circumference;
            document.getElementById('timerCircleProgress').style.strokeDashoffset = 
                circumference - progress;
        }

        function resetTimerButtons() {
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('startBtn').textContent = 'Start';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'none';
        }

        function resetTimerState() {
            timerState = {
                running: false,
                paused: false,
                totalSeconds: 1500,
                remainingSeconds: 1500,
                topic: null,
                type: 'Study'
            };
        }

        // ============= DATA MANAGEMENT =============
        function exportData() {
            const dataStr = JSON.stringify(progressData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `gcse-tracker-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function exportCSV() {
            let csv = 'Subject,Section,Topic,Status,Study Time (minutes),Notes,Sessions\n';
            
            Object.keys(curriculum).forEach(subjectId => {
                const subject = curriculum[subjectId];
                
                subject.topics.forEach(section => {
                    section.items.forEach(item => {
                        const key = getTopicKey(section.section, item);
                        const topicData = progressData[subjectId]?.[key];
                        
                        const status = topicData?.status || 'Not Started';
                        const minutes = topicData?.totalMinutes || 0;
                        const notes = (topicData?.notes || '').replace(/"/g, '""').replace(/\n/g, ' ');
                        const sessions = topicData?.sessions?.length || 0;
                        
                        csv += `"${subject.name}","${section.section}","${item}","${status}",${minutes},"${notes}",${sessions}\n`;
                    });
                });
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `gcse-tracker-data-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function exportDetailedCSV() {
            let csv = 'Subject,Section,Topic,Status,Total Minutes,Session Date,Session Minutes,Session Type,Notes\n';
            
            Object.keys(curriculum).forEach(subjectId => {
                const subject = curriculum[subjectId];
                
                subject.topics.forEach(section => {
                    section.items.forEach(item => {
                        const key = getTopicKey(section.section, item);
                        const topicData = progressData[subjectId]?.[key];
                        
                        const status = topicData?.status || 'Not Started';
                        const totalMinutes = topicData?.totalMinutes || 0;
                        const notes = (topicData?.notes || '').replace(/"/g, '""').replace(/\n/g, ' ');
                        const sessions = topicData?.sessions || [];
                        
                        if (sessions.length > 0) {
                            sessions.forEach(session => {
                                const sessionDate = new Date(session.date).toLocaleString();
                                csv += `"${subject.name}","${section.section}","${item}","${status}",${totalMinutes},"${sessionDate}",${session.minutes},"${session.type}","${notes}"\n`;
                            });
                        } else {
                            csv += `"${subject.name}","${section.section}","${item}","${status}",${totalMinutes},"","","","${notes}"\n`;
                        }
                    });
                });
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `gcse-tracker-detailed-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (confirm('This will replace all current progress. Continue?')) {
                        progressData = imported;
                        renderTopics();
                        alert('Data imported successfully! Note: This does not sync to the cloud. Use at your own risk.');
                    }
                } catch (error) {
                    alert('Error importing data. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }

        function confirmReset() {
            const confirmation = prompt('‚ö†Ô∏è WARNING: This will delete ALL your progress data!\n\nType "DELETE" (in all caps) to confirm:');
            
            if (confirmation === 'DELETE') {
                if (confirm('Are you absolutely sure? This cannot be undone!')) {
                    progressData = {};
                    renderTopics();
                    alert('‚úÖ All data has been reset successfully.');
                }
            } else if (confirmation !== null) {
                alert('Reset cancelled. Your data is safe.');
            }
        }

        // ============= DEBUG & TESTING =============
        async function showDebugInfo() {
            let debugInfo = 'üîç GCSE Tracker Debug Information\n\n';
            debugInfo += `User: ${currentUser?.email || 'Not logged in'}\n`;
            debugInfo += `User ID: ${USER_ID || 'None'}\n`;
            debugInfo += `Family ID: ${FAMILY_ID || '‚ùå NOT SET - This is the problem!'}\n`;
            debugInfo += `Role: ${userProfile?.role || 'Unknown'}\n\n`;
            
            if (!FAMILY_ID) {
                debugInfo += '‚ö†Ô∏è FAMILY_ID is not set!\n';
                debugInfo += 'This means your user profile is not loaded.\n\n';
                debugInfo += 'After closing this dialog, you will be prompted to:\n';
                debugInfo += '1. Create a new family, OR\n';
                debugInfo += '2. Join an existing family\n\n';
            }
            
            debugInfo += 'üìä Local Progress Data:\n';
            const subjectCount = Object.keys(progressData).length;
            debugInfo += `  - ${subjectCount} subjects with data\n`;
            
            let totalTopics = 0;
            Object.keys(progressData).forEach(subject => {
                const topics = Object.keys(progressData[subject]).length;
                totalTopics += topics;
                debugInfo += `  - ${subject}: ${topics} topics\n`;
            });
            debugInfo += `  - Total topics tracked: ${totalTopics}\n\n`;
            
            if (FAMILY_ID && supabaseClient) {
                debugInfo += '‚òÅÔ∏è Testing cloud connection...\n';
                try {
                    const { data, error } = await supabaseClient
                        .from('progress')
                        .select('count')
                        .eq('family_id', FAMILY_ID);
                    
                    if (error) {
                        debugInfo += `  ‚ùå Error: ${error.message}\n`;
                    } else {
                        debugInfo += `  ‚úÖ Cloud connection OK\n`;
                        debugInfo += `  ‚úÖ ${data.length} records in cloud database\n`;
                    }
                } catch (err) {
                    debugInfo += `  ‚ùå Connection failed: ${err.message}\n`;
                }
            } else {
                debugInfo += '‚ùå Not connected to cloud (not logged in or Supabase error)\n';
            }
            
            debugInfo += '\nüí° Tip: Check browser console (F12) for detailed logs';
            
            alert(debugInfo);
            console.log('=== FULL DEBUG INFO ===');
            console.log('Current User:', currentUser);
            console.log('User Profile:', userProfile);
            console.log('Progress Data:', progressData);
            console.log('Supabase Client Status:', supabaseClient ? 'Connected' : 'Not initialized');
            
            // If FAMILY_ID is not set, offer to set it up
            if (!FAMILY_ID && currentUser) {
                const setup = confirm('Would you like to set up your profile now?');
                if (setup) {
                    await manualProfileSetup();
                }
            }
        }

        async function testDataSync() {
            if (!FAMILY_ID || !currentUser) {
                alert('‚ùå Please log in first before testing sync');
                return;
            }
            
            try {
                alert('üß™ Testing data sync...\n\nThis will create a test entry in Biology.');
                
                await saveTopicProgress(
                    'biology',
                    'TEST SECTION',
                    'TEST TOPIC - Please delete',
                    'green',
                    'This is a test entry created by the debug tool'
                );
                
                alert('‚úÖ Test entry saved!\n\nPlease:\n1. Log out\n2. Log back in\n3. Check if the test entry is still there\n\nIf it is, your sync is working correctly!');
            } catch (error) {
                alert(`‚ùå Sync test failed: ${error.message}`);
            }
        }

        async function testCompletionHistory() {
            if (!FAMILY_ID || !currentUser) {
                alert('‚ùå Please log in first');
                return;
            }
            
            console.log('üß™ Testing completion_history table directly...');
            
            try {
                // Try to insert directly into completion_history
                const testData = {
                    user_id: currentUser.id,
                    family_id: FAMILY_ID,
                    email: currentUser.email,
                    subject: 'TEST',
                    section: 'TEST SECTION',
                    topic: 'TEST TOPIC - Direct Insert',
                    status: 'green',
                    previous_status: null,
                    completed_at: new Date().toISOString()
                };
                
                console.log('Attempting to insert:', testData);
                
                const { data, error } = await supabaseClient
                    .from('completion_history')
                    .insert(testData)
                    .select();
                
                if (error) {
                    console.error('‚ùå Insert failed:', error);
                    alert(`‚ùå Failed to insert into completion_history:\n\n${error.message}\n\nDetails: ${error.details || 'None'}\n\nHint: ${error.hint || 'None'}`);
                } else {
                    console.log('‚úÖ Insert successful:', data);
                    alert('‚úÖ Success! Test record inserted into completion_history.\n\nNow check:\n1. Supabase: SELECT * FROM completion_history;\n2. Analytics tab: Should show this test completion');
                }
            } catch (error) {
                console.error('‚ùå Test failed:', error);
                alert(`‚ùå Test failed: ${error.message}`);
            }
        }

        async function manualProfileSetup() {
            if (!currentUser) {
                alert('‚ùå Please log in first');
                return;
            }
            
            const confirmSetup = confirm(
                '‚ö†Ô∏è Manual Profile Setup\n\n' +
                'This will attempt to create or update your user profile.\n\n' +
                'Only use this if:\n' +
                '‚Ä¢ Your profile failed to load automatically\n' +
                '‚Ä¢ You need to change your family ID\n\n' +
                'Continue?'
            );
            
            if (!confirmSetup) return;
            
            await createUserProfile();
        }

        // ============= INITIALIZATION =============
        function init() {
            renderOverview();
        }

        window.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            
            const supabaseInitialized = initSupabase();
            
            if (supabaseInitialized && supabaseClient) {
                console.log('Starting authentication check...');
                checkAuth();

                try {
                    supabaseClient
                        .channel('progress_changes')
                        .on('postgres_changes', 
                            { event: '*', schema: 'public', table: 'progress' },
                            (payload) => {
                                console.log('Progress update received:', payload);
                                if (FAMILY_ID && payload.new && payload.new.family_id === FAMILY_ID) {
                                    loadProgressData();
                                }
                            }
                        )
                        .subscribe();
                } catch (error) {
                    console.error('Failed to set up real-time subscriptions:', error);
                }
            } else {
                console.error('Failed to initialize Supabase');
                alert('Failed to connect to database. Please check your configuration.');
            }
        });

        window.onclick = function(event) {
            const notesModal = document.getElementById('notesModal');
            if (event.target === notesModal) {
                closeNotesModal();
            }
        }
    </script>
</body>
</html>
